{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://oisp.dev/registry/schema/app.schema.json",
  "title": "OISP App Registry",
  "description": "Schema for desktop application profiles in the OISP registry",
  "type": "object",
  "required": ["version", "apps"],
  "properties": {
    "version": {
      "type": "string",
      "description": "Registry version (semver)",
      "pattern": "^\\d+\\.\\d+\\.\\d+$"
    },
    "apps": {
      "type": "object",
      "description": "Map of app_id to app profile",
      "additionalProperties": {
        "$ref": "#/definitions/AppProfile"
      }
    }
  },
  "definitions": {
    "AppProfile": {
      "type": "object",
      "required": ["name", "vendor", "category", "platforms", "signatures", "ai"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable app name"
        },
        "vendor": {
          "type": "string",
          "description": "Company/organization that makes the app"
        },
        "vendor_url": {
          "type": "string",
          "format": "uri",
          "description": "Vendor website URL"
        },
        "category": {
          "type": "string",
          "description": "App category",
          "enum": ["ai-code-editor", "ai-chat", "ai-code-assistant", "code-editor", "productivity", "terminal", "browser", "creative", "other"]
        },
        "description": {
          "type": "string",
          "description": "Brief description of the app"
        },
        "icon": {
          "type": "string",
          "description": "Icon filename (PNG)"
        },
        "platforms": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["macos", "windows", "linux"]
          },
          "minItems": 1,
          "description": "Supported platforms"
        },
        "signatures": {
          "$ref": "#/definitions/AppSignatures"
        },
        "ai": {
          "type": "string",
          "enum": ["native", "enabled", "host", "none"],
          "description": "AI integration level: native (built for AI), enabled (has AI features), host (hosts AI extensions), none"
        },
        "providers": {
          "type": "array",
          "items": { "type": "string" },
          "description": "AI providers this app uses (e.g., openai, anthropic)"
        },
        "features": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/Feature"
          },
          "description": "Map of feature_id to feature definition"
        },
        "pricing": {
          "$ref": "#/definitions/Pricing"
        },
        "detection": {
          "$ref": "#/definitions/Detection"
        },
        "security": {
          "$ref": "#/definitions/Security"
        }
      }
    },
    "AppSignatures": {
      "type": "object",
      "description": "Platform-specific signatures for app identification",
      "properties": {
        "macos": {
          "type": "object",
          "properties": {
            "bundle_id": { "type": "string", "description": "CFBundleIdentifier" },
            "bundle_id_patterns": { "type": "array", "items": { "type": "string" }, "description": "Glob patterns for bundle_id" },
            "team_id": { "type": "string", "description": "Apple Team ID from code signature" },
            "helper_bundles": { "type": "array", "items": { "type": "string" }, "description": "Helper app bundle IDs" }
          }
        },
        "windows": {
          "type": "object",
          "properties": {
            "exe": { "type": "string", "description": "Executable filename" },
            "publisher": { "type": "string", "description": "Code signature publisher" },
            "product_name": { "type": "string", "description": "Product name from version info" },
            "msix_package_family": { "type": "string", "description": "MSIX package family for Store apps" }
          }
        },
        "linux": {
          "type": "object",
          "properties": {
            "exe": { "type": "string", "description": "Executable name" },
            "package_names": { "type": "array", "items": { "type": "string" }, "description": "Package names" },
            "flatpak_id": { "type": "string" },
            "snap_name": { "type": "string" }
          }
        }
      }
    },
    "Feature": {
      "type": "object",
      "required": ["name", "patterns"],
      "properties": {
        "name": { "type": "string", "description": "Human-readable feature name" },
        "description": { "type": "string" },
        "patterns": {
          "type": "array",
          "items": { "$ref": "#/definitions/FeaturePattern" },
          "minItems": 1
        }
      }
    },
    "FeaturePattern": {
      "type": "object",
      "required": ["url"],
      "properties": {
        "url": { "type": "string", "description": "URL glob pattern (e.g., **/chat/completions)" },
        "method": { "type": "string", "enum": ["GET", "POST", "PUT", "DELETE", "PATCH"] },
        "body_contains": { "type": "string", "description": "String that must appear in request body" },
        "response_body": { "type": "string", "description": "String that must appear in response body" }
      }
    },
    "Pricing": {
      "type": "object",
      "required": ["model", "tiers"],
      "properties": {
        "model": {
          "oneOf": [
            { "type": "string", "enum": ["free", "subscription", "pay-per-use", "one-time"] },
            { "type": "array", "items": { "type": "string", "enum": ["free", "subscription", "pay-per-use", "one-time"] } }
          ],
          "description": "Pricing model(s) - can be single or array for hybrid"
        },
        "tiers": {
          "type": "array",
          "items": { "$ref": "#/definitions/PricingTier" }
        }
      }
    },
    "PricingTier": {
      "type": "object",
      "required": ["id", "name"],
      "properties": {
        "id": { "type": "string", "description": "Tier identifier (e.g., free, pro, business)" },
        "name": { "type": "string", "description": "Display name" },
        "type": { "type": "string", "enum": ["free", "individual", "team", "enterprise"] },
        "monthly_usd": { "type": ["number", "null"], "description": "Monthly price in USD (null for contact sales)" },
        "annual_usd": { "type": "number", "description": "Annual price in USD" },
        "self_serve": { "type": "boolean", "description": "Can sign up without sales contact" },
        "features": { "type": "array", "items": { "type": "string" }, "description": "Key features in this tier" }
      }
    },
    "Detection": {
      "type": "object",
      "properties": {
        "subscription": {
          "type": "array",
          "items": { "$ref": "#/definitions/DetectionRule" },
          "description": "Rules for detecting user's subscription tier"
        },
        "tier_indicators": {
          "type": "array",
          "items": { "$ref": "#/definitions/TierIndicator" }
        }
      }
    },
    "DetectionRule": {
      "type": "object",
      "required": ["type", "url"],
      "properties": {
        "type": { "type": "string", "enum": ["api_response", "header", "cookie"] },
        "url": { "type": "string", "description": "URL pattern to match" },
        "extract": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "JSONPath expressions to extract values"
        }
      }
    },
    "TierIndicator": {
      "type": "object",
      "required": ["url", "indicates"],
      "properties": {
        "url": { "type": "string" },
        "response_contains": { "type": "string" },
        "indicates": { "type": "string", "description": "Tier ID this indicates" }
      }
    },
    "Security": {
      "type": "object",
      "properties": {
        "compliances": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name"],
            "properties": {
              "name": { "type": "string", "description": "Compliance name (e.g., SOC 2 Type II)" },
              "url": { "type": "string", "format": "uri", "description": "Link to compliance info" }
            }
          }
        },
        "trains_on_data": { "type": "boolean", "description": "Whether vendor trains on user data" },
        "sso_available": { "type": "boolean" }
      }
    }
  }
}
